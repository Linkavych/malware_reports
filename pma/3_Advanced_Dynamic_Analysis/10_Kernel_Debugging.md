# Kernel Debugging

## Lab 10-1

This lab includes both a driver and an executable. You can run the execut-
able from anywhere, but in order for the program to work properly, the
driver must be placed in the C:\Windows\System32 directory where it was origi-
nally found on the victim computer. The executable is Lab10-01.exe, and the
driver is Lab10-01.sys.

1. Does this program make any direct changes to the registry? (Use procmon
to check.)

> Yes, the kernel driver that is loaded by the executable will create or modidy
> HKLM\SOFTWARE\Policies\Microsoft\WindowsFireWall\StandardProfile and DomainProfile. This will disable the
> firewall on a Windows XP system.

2. The user-space program calls the ControlService function. Can you set a
breakpoint with WinDbg to see what is executed in the kernel as a result
of the call to ControlService?

> The executable must be opened in windbg on the virtual machine, and while debugging the kernel
> from the host machine. `!drvobj` gets a handle to the driver object, and then set a breakpoint on the unload function from the driver.

3. What does this program do?

> This program will create a service which loads and executes a malicious kernel driver. 
> The driver modifies the registry to disable the Windows XP firewall.


## Lab 10-2
The file for this lab is Lab10-02.exe.

1. Does this program create any files? If so, what are they?

> The initial loader sample will install a kernel driver at `c:\windows\system32\Mlwx486.sys`. This driver is contained within
> the loader as a resource. It creates a service to call the driver named `486 WS Driver`

2. Does this program have a kernel component?

> Yes, this is a malicious driver stored in the .rsrc section of the loader sample.

3. What does this program do?

> Creates a service on the victim named `486 WS Driver`, and loads the malicious driver from the .rsrc section of the loader binary.
> This driver is saved as `c:\windows\system32\Mlwx486.sys`. The loader then starts the service, and the malicious driver executes.
> The driver is using SSDT hooking to overwrite the entry to NtQueryDirectoryFile, and will hide any files
> beginning with `Mlwx`.

## Lab 10-3

This lab includes a driver and an executable. You can run the executable
from anywhere, but in order for the program to work properly, the driver
must be placed in the C:\Windows\System32 directory where it was originally
found on the victim computer. The executable is Lab10-03.exe, and the driver
is Lab10-03.sys.

1. What does this program do?

> Creates a service named 'Process Helper' which will use the driver located at `c:\windows\system32\Lab03-03.sys`.
> It will then create a device (`\\.\\ProcHelper`) to use for communication. The program will then execute the service
> and begin displaying a pop-up ad every 30 seconds. Further, the process itself will not appear in a process listing.
> The sample is manipulating the PE header to unlink the current process.

2. Once this program is running, how do you stop it?

> Reboot and snapshot back to an earlier image.

3. What does the kernel component do?

> The kernel component will unlink the process making a request with DeviceIoControl from the
> linked list of processes, hiding the process.
