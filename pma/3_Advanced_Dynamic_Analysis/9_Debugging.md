---

Author: @linkavych
Date: 2022-08-23

---
# Debugging

## Lab 9-1

Analyze the malware found in the file Lab09-01.exe using OllyDbg and IDA
Pro to answer the following questions. This malware was initially analyzed in
the Chapter 3 labs using basic static and dynamic analysis techniques.

1. How can you get this malware to install itself?

> This sample can be installed by executing the binary with the command-line option '-in'
> and the binary's password: 'abcd'.

2. What are the command-line options for this program? What is the pass-
word requirement?

> '-in' - install
> '-re' - remove
> '-c' - change configuration
> '-cc' - check configuration
> PW: 'abcd'

3. How can you use OllyDbg to permanently patch this malware, so that it
doesnâ€™t require the special command-line password?

> One way is to patch the 'JNZ' instruction following the call to the 'Check_Password'
> subroutine, making the 'JNZ' a 'JMP'. This will cause the program to always jump further
> into the instructions, rather than deleting itself if the password is not provided.

4. What are the host-based indicators of this malware?

> '%s Manager Service'
> 'HKLM\SOFTWARE\Microsoft \XPS\'
> The malware is also copied to the system32 directory where it is renamed to match the service name.

5. What are the different actions this malware can be instructed to take via
the network?

> SLEEP - the malware will sleep for a specified amount of time
> DOWNLOAD - downloads a file from the target system
> UPLOAD - uploads a file to the target system
> NOTHING - does nothing
> CMD - executes a cmd on the target system

6. Are there any useful network-based signatures for this malware?

> http://www[.]practicalmalwareanalysis.com
> HTTP/1.o\r\n\r\n - GET Requests
> No headers are sent with the beacon requets, and the actual webserver is configurable
> via the malware's internal functions.


## Lab 9-2

Analyze the malware found in the file Lab09-02.exe using OllyDbg to answer
the following questions.

1. What strings do you see statically in the binary?

> The only strings found initially are the imported libraries, functions, and 'cmd'. However, using a tool
> like FLOSS, also shows the presence of several stack strings in the binary (ocl.exe and 1qaz2wsx3edc. Floss also 
> will decode the XOR encoded data hiding the C2 server: www.practicalmalwareanalysis[.]com.

2. What happens when you run this binary?

> Nothing appears to happen.

3. How can you get this sample to run its malicious payload?

> The sample needs to be renamed 'ocl.exe' in order to run the payload - the binary checks for this name when executing,
> and will bail out if it is not named this.

4. What is happening at 0x00401133?

> There are two stack strings here, being stored by character in local variables. They will get rebuilt on the stack and stored for use by the 
> sample.

5. What arguments are being passed to subroutine 0x00401089?

> The XOR Key (1qaz2wsx3edc) and the encoded data which contains the C2 URL. This subroutine
> will decode the encoded data for use.

6. What domain name does this malware use?

> www[.]practicalmalwareanalysis.com

7. What encoding routine is being used to obfuscate the domain name?

> XOR encoding using '1qaz2wsx3edc' as the key.

8. What is the significance of the CreateProcessA call at 0x0040106E?

> This is creating a reverse command shell back to the attacker's machine. The call is setting
> stdout, stdin, and stderr to the socket, and calling cmd.exe to allow the execution of commands via
> this remote connection.


## Lab 9-3

Analyze the malware found in the file Lab09-03.exe using OllyDbg and IDA Pro.
This malware loads three included DLLs (DLL1.dll, DLL2.dll, and DLL3.dll)
that are all built to request the same memory load location. Therefore, when
viewing these DLLs in OllyDbg versus IDA Pro, code may appear at different
memory locations. The purpose of this lab is to make you comfortable with
finding the correct location of code within IDA Pro when you are looking at
code in OllyDbg.

1. What DLLs are imported by Lab09-03.exe?

> dll1.dll, dll2.dll, netapi32.dll, kernel32.dll

2. What is the base address requested by DLL1.dll, DLL2.dll, and DLL3.dll?

> 10000000

3. When you use OllyDbg to debug Lab09-03.exe, what is the assigned based
address for: DLL1.dll, DLL2.dll, and DLL3.dll?

> Using x64Dbg:
> 1. dll1 - 0x10000000
> 2. dll2 - 0x00420000
> 3. dll3 - 0x00470000

4. When Lab09-03.exe calls an import function from DLL1.dll, what does
this import function do?

> This functions prints the mystery data from DLL1: 1 (a global variable)

5. When Lab09-03.exe calls WriteFile, what is the filename it writes to?

> temp.txt

6. When Lab09-03.exe creates a job using NetScheduleJobAdd, where does it get
the data for the second parameter?

> By dynamically resolving DLL3GetStructure to obtain the data.

7. While running or debugging the program, you will see that it prints out
three pieces of mystery data. What are the following: DLL 1 mystery
data 1, DLL 2 mystery data 2, and DLL 3 mystery data 3?

> Dll 1 - Current Process id
> Dll 2 - Handle to file (temp.txt)
> Dll 3 - Address in memory of string 'ping www.malwareanalysis.com'

8. How can you load DLL2.dll into IDA Pro so that it matches the load
address used by OllyDbg?

> In ghidra, click on 'Window' -> 'Memory Map' -> Click House Icon -> Set address
