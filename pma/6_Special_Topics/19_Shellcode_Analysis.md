# Shellcode Analysis

In these labs, we’ll use what we’ve covered in Chapter 19 to analyze samples
inspired by real shellcode. Because a debugger cannot easily load and run
shellcode directly, we’ll use a utility called shellcode_launcher.exe to dynamically
analyze shellcode binaries. You’ll find instructions on how to use this utility
in Chapter 19 and in the detailed analyses in Appendix C.

## Lab 19-1

Analyze the file Lab19-01.bin using shellcode_launcher.exe.

1. How is the shellcode encoded?

> Alphabetic encoding; stored in lower nibble of two encoded bytes.

2. Which functions does the shellcode manually import?

> LoadLibraryA
> GetSystemDirectoryA
> TerminateProcess
> GetCurrentProcess
> WinExec
> URLDownloadToFileA

3. What network host does the shellcode communicate with?

> http://www.practicalmalwareanalysis[.]com/shellcode/annoy_user.exe

4. What filesystem residue does the shellcode leave?

> The file will be saved to %SYSTEMROOT%\system32\1.exe

5. What does the shellcode do?

> Downloads a file from a webpage and executes it.


## Lab 19-2

The file Lab19-02.exe contains a piece of shellcode that will be injected into
another process and run. Analyze this file.

1. What process is injected with the shellcode?

> The default browser on the system is targeted for injection. In most cases this would be Internet Explorer.

2. Where is the shellcode located?

> 0x407030

3. How is the shellcode encoded?

> XOR'd with 0xE7

4. Which functions does the shellcode manually import?

> LoadLibraryA
> WSAStartup
> WSASocket
> connect
> CreateProcessA
> GetCurrentProcess
> TerminateProcess

5. What network hosts does the shellcode communicate with?

> 192.168.200.2 on port 13330

6. What does the shellcode do?

> Initiates a reverse shell connection.


## Lab 19-3

Analyze the file Lab19-03.pdf. If you get stuck and can’t find the shellcode,
just skip that part of the lab and analyze file Lab19-03_sc.bin using
shellcode_launcher.exe.

1. What exploit is used in this PDF?

> Using pdfstreamdumper, the 'Exploits_Scan' tab shows the exploit for CVE-2008-2992 is found in stream 9.
> This is a buffer overflow in the 'util.printf' function in Adobe Acrobat.

2. How is the shellcode encoded?

> The shellcode is encoded in javascript percent encoding.

3. Which functions does the shellcode manually import?

> LoadLibraryA
> CreateProcessA
> SetFilePointer
> TerminateProcess
> GetCurrentProcess
> GetTempPathA
> SetCurrentDirectoryA
> CreateFileA
> GetFileSize
> ReadFile
> WriteFile
> CloseHandle
> GlobalAlloc
> GlobalFree
> ShellExecuteA

4. What filesystem residue does the shellcode leave?

> %TEMP%\foo.exe and %TEMP%\bar.pdf

5. What does the shellcode do?

> The shellcode extracts two files embedded in the pdf, storing them in the %TEMP% directory.
> The shellcode then executes the `foo.exe` file, and opens the `bar.pdf` file.
