# Anti-Virtual Machine Techniques

## Lab 17-1

Analyze the malware found in Lab17-01.exe inside VMware. This is the same
malware as Lab07-01.exe, with added anti-VMware techniques.
NOTE The anti-VM techniques found in this lab may not work in your environment.

1. What anti-VM techniques does this malware use?

> The sample uses the `SIDT`, `SLDT`, and `STR` instructions.

2. If you have the commercial version of IDA Pro, run the IDA Python
script from Listing 17-4 in Chapter 17 (provided here as findAntiVM.py).
What does it find?

> See answer 1.

3. What happens when each anti-VM technique succeeds?

> The sample will terminate if `SLDT` fails, but the malicious service wil be created. If `SIDT` or `STR` fail, the malware will delete itself.

4. Which of these anti-VM techniques work against your virtual machine?

> None.

5. Why does each anti-VM technique work or fail?

> Mainly because I'm using Proxmox, not VMWare.

6. How could you disable these anti-VM techniques and get the malware to run?

> NOP the instructions or flip the instructions if debugging.

## Lab 17-2

Analyze the malware found in the file Lab17-02.dll inside VMware. After
answering the first question in this lab, try to run the installation exports
using rundll32.exe and monitor them with a tool like procmon. The following
is an example command line for executing the DLL:
rundll32.exe Lab17-02.dll,InstallRT (or InstallSA/InstallSB)

1. What are the exports for this DLL?

> InstallRT
> InstallSA
> InstallSB
> PSLIST
> ServiceMain
> StartEXS
> UninstallRT
> UninstallSA
> UninstallSB

2. What happens after the attempted installation using rundll32.exe?

> `rundll32.exe lab17-02.dll,InstallRT` - A file is created in the directory named `xinstall.log`. 
> This log file contains the actions taken, or attempted, by the sample.
> The DLL is copied to `c:\windows\system32\`, and it attempts to inject into the `iexplore.exe` process.
> 
> Of note, my virtual machine is running in Proxmox, and appeared to execute normally except
> for the injection of malicious code. The file did not self-delete, or anything that would suggest Anti-VM.
>

3. Which files are created and what do they contain?

> `xinstall.log` - contains information related to the installation of the sample on a target system. Whether actions succeeded or failed.
> Thee sample DLL is also copied to the `c:\windows\system32` folder. A `.bat` file is created and used for self-deletion if a Virtual Machine
> is detected.

4. What method of anti-VM is in use?

> This sample is querying the I/O port and testing the result against the strings 'VXh' and 'VMXh', which are consistent with VMWare.

5. How could you force the malware to install during runtime?

> Setup the virtual machine to not have this signature, bypass in the debugger, or NOP out the section.

6. How could you permanently disable the anti-VM technique?

> NOP out the check.

7. How does each installation export function work?

> InstallRT - uses DLL injection into a process, which can be provided as a parameter.
> InstallSA - Installation via a malicious service.
> InstallSB - installation via service and DLL injection if the service is running.


## Lab 17-3

Analyze the malware Lab17-03.exe inside VMware. This lab is similar to
Lab12-02.exe, with added anti-VMware techniques.

1. What happens when you run this malware in a virtual machine?

> The malware wil terminate if you are using VMWare as the virtualization mechanism. Otherwise, it would still inject the malicious
> process into svchost.exe.

2. How could you get this malware to run and drop its keylogger?

> Bypass the subroutines that perform the VMWare detection checks

3. Which anti-VM techniques does this malware use?

> The sample checks to VMWare I/O port, checks the registry at `SYSTEM\CurrentControlSet\Control\DeviceClasses` for 'vmware', checks the MAC address to compare against
> the known VMWare MAC, and searches the process list with a string hashing function to amy 'vmware' processes.

4. What system changes could you make to permanently avoid the anti-VM
techniques used by this malware?

> Remove the VMWare tools and change the MAC address for the NIC.

5. How could you patch the binary in OllyDbg to force the anti-VM tech-
niques to permanently fail?

> 0x40145d - NOP the instructions here
> 0x40199F - XOR EAX, EAX
> 0x4019BE - XOR EAX, EAX
> 0x40169F - JMP 0x40184A
