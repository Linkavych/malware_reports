---

author: @linkavych
date: 2022-08-31

---
# Anti-Debugging

## Lab 16-1

Analyze the malware found in Lab16-01.exe using a debugger. This is the
same malware as Lab09-01.exe, with added anti-debugging techniques.

1. Which anti-debugging techniques does this malware employ?

> This sample is manually parsing the PEB structure to determine if a debugger is being used on the sample. 
> First, it queries the `BEINGDEBUGGED` value within the PEB structure. Next, it tests for the `FORCE FLAGS` in the `PROCESS HEAP`.
> Finally, it tests for the value of the `NTGLOBAL` flags within the PEB structure - a result of 0 means the
> process is being debugged.

2. What happens when each anti-debugging technique succeeds?

> The sample will attempt to delete itself from the system.

3. How can you get around these anti-debugging techniques?

> Either manually reset the flags when stepping through with a debugger, or use a debugger hiding tool for your debugger of choice.

4. How do you manually change the structures checked during runtime?

> You can edit the flags and byte locations within the debugger.

5. Which OllyDbg plug-in will protect you from the anti-debugging techniques used by this malware?

> ScyllaHide


## Lab 16-2

Analyze the malware found in Lab16-02.exe using a debugger. The goal of this
lab is to figure out the correct password. The malware does not drop a malicious payload.

1. What happens when you run Lab16-02.exe from the command line?

> The sample prints a usage string stating the neeed for a four character password.

2. What happens when you run Lab16-02.exe and guess the command-line
parameter?

> If the password is incorrect, the sample outputs the string "Incorrect password, Try again."

3. What is the command-line password?

> 'byrr'

4. Load Lab16-02.exe into IDA Pro. Where in the main function is strncmp
found?

> 0x4011e0

5. What happens when you load this malware into OllyDbg using the
default settings?

> The malware sample will terminate.

6. What is unique about the PE structure of Lab16-02.exe?

> The structure contains a .tls section for Thread Local Storage. This will execute before a debugger has an opportunity to catch it.

7. Where is the callback located? (Hint: Use CTRL -E in IDA Pro.)

> THe TLS Callback is located at 0x401060.

8. Which anti-debugging technique is the program using to terminate
immediately in the debugger and how can you avoid this check?

> The sample uses the FindWindowA function to find any open windows containing the string 'OLLYDBG'; terminating if found.
> The sample also uses SetLastError and OutputDebugStringA to set an error code if a debugger is not present, allowing the program to continue execution.

9. What is the command-line password you see in the debugger after you
disable the anti-debugging technique?

> 'bzqr'

10. Does the password found in the debugger work on the command line?

> No, it does not work from the command line.

11. Which anti-debugging techniques account for the different passwords in
the debugger and on the command line, and how can you protect against them?

> OutputDebugStringA and BeingDebugged flag are both used as inputs into the decoding algorithm. Use scyllahide, and NOP-out
> the add instructions at 0x401051.


## Lab 16-3

Analyze the malware in Lab16-03.exe using a debugger. This malware is simi-
lar to Lab09-02.exe, with certain modifications, including the introduction of
anti-debugging techniques. If you get stuck, see Lab 9-2.

1. Which strings do you see when using static analysis on the binary?

> The list of imported functions, 'cmd.exe', 'cmd', '/c del'.

2. What happens when you run this binary?

> It immediately terminates.

3. How must you rename the sample in order for it to run properly?

> `peo.exe`

4. Which anti-debugging techniques does this malware employ?

> The sample calls QueryPerformanceCounter to generate a time difference, to see if the program is executing within a debugger. 
> It also calls GetTickCount twice to generate a subsequent time differential for the same purposes. Finally, the sample calls `rtdsc` twice as well as an anti-debugging measure.

5. For each technique, what does the malware do if it determines it is
running in a debugger?

> The malware will attempt to delete itself from the system.

6. Why are the anti-debugging techniques successful in this malware?

> The timing checks cause and catch exceptions that are handled by the Structured Exception handling mecahnism. These exceptions are handled more slowly in
> a debugger than on a normal system.

7. What domain name does this malware use?

> adg.malwareanalysisbook.com
