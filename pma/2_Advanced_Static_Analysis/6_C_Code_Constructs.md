---

Author: @linkavych
Date: 2022-08-22

---
# C Code Constructs in Assembly

The goal of the labs for this chapter is to help you to understand the overall
functionality of a program by analyzing code constructs. Each lab will guide
you through discovering and analyzing a new code construct. Each lab builds
on the previous one, thus creating a single, complicated piece of malware
with four constructs. Once you’ve finished working through the labs, you
should be able to more easily recognize these individual constructs when you
encounter them in malware.

## Lab 6-1

In this lab, you will analyze the malware found in the file Lab06-01.exe.

1. What is the major code construct found in the only subroutine called
by main?

> An IF Statement is located at 0x00401000

2. What is the subroutine located at 0x40105F?

> printf

3. What is the purpose of this program?

> The program will check for an internet connection, if successful it will print
> Success: Internet Connection. If not, it will print Error 1.1: No Internet. This is a simple check that can be used by malware to 
> attempt connecting to the internet.


## Lab 6-2

Analyze the malware found in the file Lab06-02.exe.

1. What operation does the first subroutine called by main perform?
i
> Tests for an internet connection.

2. What is the subroutine located at 0x40117F?

> Prints

3. What does the second subroutine called by main do?

> Connects to a URL with the User-Agent of Internet Explorer 7.5/pma. The website connected to is http[:]//www.practicalmalwareanalysis.com/cc.htm.
> If the connection fails, the program will exit. If successful, the sample will read in the file located at that address. The first four bytes of the file will be compared
> against specific characters (<, !, -, -) as a test, and the fifth byte will be saved into a variable and returned to the calling function. If asuccessful, the command will be printed to the screen in the calling function
> before the malware sleeps for one minute.

4. What type of code construct is used in this subroutine?

> The type of code construct used is an IF-ELSE statement with nesting. The subroutine uses an array to store the data
> from the webpage, before comparing it one byte at a time in the IF-ELSE statement.

5. Are there any network-based indicators for this program?

> http://www[.]practicalmalwareanalysis[.com]/cc.htm
> User-Agent: Internet Explorer 7.5/pma

6. What is the purpose of this malware?

> The purpose of the malware is to connect to a webpage, and download a file. The malware will check the beginning of the file for a specific marker (<!--),
> and if present, will parse out the following command. This is a simple form of command and control that could abuse legitimate websites.
> On success, this sample will sleep for one minute.

## Lab 6-3
In this lab, we’ll analyze the malware found in the file Lab06-03.exe.

1. Compare the calls in main to Lab 6-2’s main method. What is the new
function called from main?

> The new function is located at 0x401130 (ghidra). This function is a switch statement construct. This subroutine receives
> the command character via ECX from the calling routine. This character is compared against the
> switch statement to determine the next action by the malware sample.

2. What parameters does this new function take?

> The subroutine takes in two parameters: 1. the command character and 2. an existing filename.

3. What major code construct does this function contain?

> Switch statement

4. What can this function do?

> Depending on the option selected by the command:
>   - a - Create a directory: c:\Temp\
>   - b - Copy the file c:\Temp\cc.exe to another file location (overwriting)
>   - c - Delete the file c:\temp\cc.exe
>   - d - Open the registry key HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run, and set the key Malware to c:\temp\cc.exe.
>   - e - Sleep for 100 seconds

5. Are there any host-based indicators for this malware?

> c:\temp\cc.exe
> HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\Malware

6. What is the purpose of this malware?

> This malware will check for an internet connection, connect to a website and parse the data for a command structure. Depending on the command 
> character in the data, the sample will execute one of a number of options.

## Lab 6-4
In this lab, we’ll analyze the malware found in the file Lab06-04.exe.

1. What is the difference between the calls made from the main method in
Labs 6-3 and 6-4?

> The calls made to the C2 function and switch subroutine are placed inside of a for loop.

2. What new code construct has been added to main?

> For loop

3. What is the difference between this lab’s parse HTML function and
those of the previous labs?

> The C2 function now accepts a parameter, and the C2 functions calls sprintf with the User-Agent to build the User-Agent fo connecting
> to the target website.

4. How long will this program run? (Assume that it is connected to the
Internet.)

> 1440 minutes (24 hours).

5. Are there any new network-based indicators for this malware?

> User-Agent: Internet Explorer 7.50/pma%d - %d is the number of minutes the program has ran
> http[://]www[.]practicalmalwareanalysis.com/cc.htm"

6. What is the purpose of this malware?

> The program will run for 24 hours, assuming there is an internet connection present. It will then connect to a website
> to parse the site for a comment (<!--), and then compare the fifth character against a switch
> statement to determine the hard-coded command to take.
