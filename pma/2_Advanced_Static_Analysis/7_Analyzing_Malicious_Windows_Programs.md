---

Author: @linkavych
Date: 2022-08-22

---
# Analyzing Malicious Windows Programs

## Lab 7-1

Analyze the malware found in the file Lab07-01.exe.

1. How does this program ensure that it continues running (achieves per-
sistence) when the computer is restarted?

> The sample will create a new service called 'MALSERVICE' that will automaticall start when the system reboots.

2. Why does this program use a mutex?

> The program uses a mutex to test if it is already present on the system. The mutex name of `HGL345`
> is tested by the malware through a call to `OpenMutexA`. If already present, the malware will exit. Otherwise, it
> will create the new service and execute.

3. What is a good host-based signature to use for detecting this program?

> The presence of `MALSERVICE` and the mutex of `HGL345`.

4. What is a good network-based signature for detecting this malware?

> User-Agent: Internet Explorer 8.0
> http[:]//www.malwareanalysisbook.com

5. What is the purpose of this program?

> The malware will install itself as a service and then will wait on a timer until January 1, 2100 at
> midnight. Then it will create 20 threads, and repeatedly attempt to open the target URL. A simple DOS attack.

6. When will this program finish executing?

> It does not stop execution. An infinite while loop is used to continue requesting the webpage.


## Lab 7-2

Analyze the malware found in the file Lab07-02.exe.

1. How does this program achieve persistence?

> This sample does nto appear to have a persistence mechanism.

2. What is the purpose of this program?

> This sample will create a COM object in order to connect to the website http[:]//www.malwareanalysisbook.com/ad.html.

3. When will this program finish executing?

> The program will execute once and exit.


## Lab 7-3

For this lab, we obtained the malicious executable, Lab07-03.exe, and DLL,
Lab07-03.dll, prior to executing. This is important to note because the mal-
ware might change once it runs. Both files were found in the same directory
on the victim machine. If you run the program, you should ensure that both
files are in the same directory on the analysis machine. A visible IP string
beginning with 127 (a loopback address) connects to the local machine. (In
the real version of this malware, this address connects to a remote machine,
but we’ve set it to connect to localhost to protect you.)

This lab may be a bit more challenging than previous ones. You’ll need
to use a combination of static and dynamic methods, and focus on the big
picture in order to avoid getting bogged down by the details.

1. How does this program achieve persistence to ensure that it continues
running when the computer is restarted?

> The sample will recursively search for every EXE file located on the system, map the file into memory, and replace kernel32.dll
> in its imports to be kerne132.dll - an impostor dll. The impostor DLL will be copied to c:\windows\system32 as kerne132.dll - with a one instaead of an 'l'.
> The malware will then be called any time an executable is ran on the target system.

2. What are two good host-based signatures for this malware?

> kerne132.dll
> SADFHUHF - Mutex Name

3. What is the purpose of this program?

> The sample will install a backdoor onto the target system by impersonating kernel32.dll with an impostor, and
> overwriting every exe on the target to call this impostor dll.

4. How could you remove this malware once it is installed?

> Reimage. Overwrite the impostor kerne132.dll with a copy of a known-good kenerl32.dll. Execute similar code to rewrite each EXE on the target. But seriously, reimage.
