# Malware Behavior

## Lab 11-1

Analyze the malware found in Lab11-01.exe.

1. What does the malware drop to disk?

> The initial sample will drop a DLL to disk at HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\GinaDLL.

2. How does the malware achieve persistence?

> By establishing itself in the Winlogon registry key as GinaDLL. This will be loaded on reboot.

3. How does the malware steal user credentials?

> It loads a Gina interceptor, which logs all credentials to `msutil32.sys`.

4. What does the malware do with stolen credentials?

> Write them to the file `msutil32.sys` at `%SYSTEMROOT%\System32\`. It will write the domain, username, password, and timestamp.

5. How can you use this malware to get user credentials from your test
environment?

> Log out and back in to the victim system and the malware will write the credentials to the file.


## Lab 11-2

Analyze the malware found in Lab11-02.dll. Assume that a suspicious file
named Lab11-02.ini was also found with this malware.

1. What are the exports for this DLL malware?

> entry and installer

2. What happens after you attempt to install this malware using
rundll32.exe?

> The malware will copy itself to `c:\windows\system32\spoolvxx32.dll` and establish persistence
> by using the APPINIT DLL: `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows, Key: AppInit_DLLs`.
> The malware will then try to open the INI file from the system directory, but it will not find it there.

3. Where must Lab11-02.ini reside in order for the malware to install
properly?

> `c:\windows\system32\Lab11-02.ini`

4. How is this malware installed for persistence?

> The malware will load itself into every process that uses User32.dll by abusing the APPINIT registry key at
> `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows` in the AppInit_DLLs value.

5. What user-space rootkit technique does this malware employ?

> The sample is using inline hooking to hook calls to `send`.

6. What does the hooking code do?

> The code is hooking send so that when there is a call to send, the sample will check for the string
> 'RCPT TO:' and, if present, add another malicious email to the CC line before sending.

7. Which process(es) does this malware attack and why?

> This sample targets mail applications (outlook, thebat, and msimn)

8. What is the significance of the .ini file?

> The ini files contains an encrypted email address: billy@malwareanalysisbook.com

9. How can you dynamically capture this malwareâ€™s activity with Wireshark?

> Spoof a mailserver using python, send an email with one of the target programs, and capture the traffic with Wireshark.

## Lab 11-3

Analyze the malware found in Lab11-03.exe and Lab11-03.dll. Make sure that
both files are in the same directory during analysis.

1. What interesting analysis leads can you discover using basic static
analysis?

> DLL - The dll imports several suspicious functions, but prominently uses `GetAsyncKeyState` which is commonly used in keyloggers. 
> Also, the dll has a single export: `zzz69806582`, which does not inspire confidence. Several strings are present which also provide leads for further analysis:
> Lab1103dll.dll, C:\WINDOWS\System32\kernel64x.dll. FLOSS also shows a stack string that is built, which again points to a potential keylogger: `<SHIFT>`.
>
> EXE - The exe imports several functions used with Process Hollowing: `UnmapViewOfFile, MapViewOfFile, CreateProcessA`. Strings shows several worth further analysis:
> 'net start cisvc', 'c:\windows\system32\%s', 'command.com', 'c:\windows\system32\inet_epar32.dll', .com, .bat, .exe, .cmd, and 'cisvc.exe'. It also contains the string for the exported function from the
> DLL.

2. What happens when you run this malware?

> A popup command box states that the 'Indexing service is starting.' The DLL will be written to `c:\windows\system32\inet_epar32.dll`. The indexing service (`cisvc.exe`) is manipulated, and started.
> Another file is created at `c:\windows\system32\kernel64x.dll` which is just a text file for storing logged keystrokes.

3. How does Lab11-03.exe persistently install Lab11-03.dll?

> The DLL will be written to disk at `c:\windows\system32\inet_epar32.dll`.

4. Which Windows system file does the malware infect?

> `cisvc.exe`

5. What does Lab11-03.dll do?

> The DLL wil check for a MUTEX, or create one if the malware is not already running. It will then create the logging file,
> and then begin writing data to the log file.

6. Where does the malware store the data it collects?

> `c:\windows\syetem32\kernel64x.dll`
