# Malware Focused Network Signatures

This chapter’s labs focus on identifying the networking components of mal-
ware. To some degree, these labs build on Chapter 13, since when develop-
ing network signatures, you’ll often need to deal with encoded content.


## Lab 14-1

Analyze the malware found in file Lab14-01.exe. This program is not harmful
to your system.

1. Which networking libraries does the malware use, and what are their
advantages?

> The sample uses `urlmon.dll` for networking. The library is relatively simple to use for interacting
> with websites, downloading data, and otherwise constructiing a C2 mechanism.

2. What source elements are used to construct the networking beacon, and
what conditions would cause the beacon to change?

> The beacon is built with a call to `GetCurrentHwProfileA` and `GetUsernameA`. The first returns a struct which is parsed
> by the malware to obtain the target's GUID. The second function returns the username of the user who activated the beacon.
> For this beacon to change, either a new GUID would need to be assigned to the system, or the username of the target would need to be different.

3. Why might the information embedded in the networking beacon be of
interest to the attacker?

> The GUID provides a unique identifier for the target system that has been infected, and the 
> username could give them some indication of the privileges of the user involved. It is not
> uncommon to find a user named `admin` for instance.

4. Does the malware use standard Base64 encoding? If not, how is the
encoding unusual?

> This malware uses non-standard Base64 encoding with 'a' as padding, instead of '='.

5. What is the overall purpose of this malware?

> The malware will download and execute a file from `www[.]practicalmalwareanalysis[.]com/%s/%c.png`. The malware will 
> execute this GET request once to download a PNG file from the target host and execute that download. The file will be downloaded to
> `c:\documents and settings\linkavych\local settings\temporary internet files\o.png` on a Windows XP system. Navigating to this directory
> should make it obvious where the file is downloaded from.

6. What elements of the malware’s communication may be effectively
detected using a network signature?

> The samples User Agent is based on the system from which the sample is executed, and will change depending on that. However, the sample
> will request the same base URL: `http://www[.]practicalmalwareanalysis[.]com`. Additionally, the URI requested will be BASE64 encoded
> containing the MAC address of the targeted system, and the user name of the victim. The downloaded filename will consist of a single character: [a-zA-Z0-9].png.

7. What mistakes might analysts make in trying to develop a signature for
this malware?

> Targeting elements of the sample other than the URI.

8. What set of signatures would detect this malware (and future variants)?

```snort
alert tcp $INT_NET any -> $EXT_NET $HTTP_PORTS (msg: "Lab14.1 - PMA - Beacon - Colons and Dashes";
urilen:>32; content:"GET|20|/"; depth 5; pcre:"/GET\x20\/[a-zA-Z0-9+\/]{3}6[a-zA-Z0-9+\/]{3}6[a-zA-Z0-9+\/]{3}6[a-zA-Z0-9+\/]{3}6[a-zA-Z0-9+\/]{3}6[a-zA-Z0-9+\/]{3}t([A-Za-z0-9+\/]{4}){1,}\//";
sid: 00000001; rev:1;)
```

```snort
alert tcp $INT_NET any -> $EXT_NET $HTTP_PORTS (msg: "Lab14.1 - PNG download";
urilen:>32; uricontent:".png"; pcre:"/\/[A-Za-z0-9+\/]{24,}([A-Za-z0-9+\/])\/\1\.png/";
sid:00000002; rev:1;)
```

```snortv3
alert http $INT_NET any -> $EXT_NET $HTTP_PORTS 
(
    msg:"Lab14.2 - Domain name";
    http_header: field host;
    content:"www.practicalmalwareanalysis.com"; 
    sid: 00000003; 
    rev:1;
)
```


## Lab 14-2

Analyze the malware found in file Lab14-02.exe. This malware has been con-
figured to beacon to a hard-coded loopback address in order to prevent it
from harming your system, but imagine that it is a hard-coded external
address.

1. What are the advantages or disadvantages of coding malware to use
direct IP addresses?

> The advantage is that it is simple and direct for connecting back to a C2 server. There is no need to maintain
> DNS infrastructure to support attacker operations. However, it is obvious to defenders
> because most humans and legitimate software will use DNS to navigate the internet.

2. Which networking libraries does this malware use? What are the advan-
tages or disadvantages of using these libraries?

> This sample uses the `wininet.dll` library for network connectivity. This library is more configurable
> for the attacker, but also requires additional coding and setup to execute.

3. What is the source of the URL that the malware uses for beaconing?
What advantages does this source offer?

> The IP address used by the malware is a hardcoded string within the sample. The sample does not use
> DNS to resolve the query. This ensures connection back to the specific server required by the C2,
> but is easy to spot for a defender.

4. Which aspect of the HTTP protocol does the malware leverage to
achieve its objectives?

> The sample uses the User-Agent, with custom base64 encoding to smuggle the reverse shell back to the C2 server.

5. What kind of information is communicated in the malware’s initial
beacon?

> The command prompt with version information from Windows.

6. What are some disadvantages in the design of this malware’s communi-
cation channels?

> Outgoing information is encoded, but incoming commands are not - allowing defenders to see how the C2 works directly. 
> The User-Agent field is used to distinguish between the two communications fields. 

7. Is the malware’s encoding scheme standard?

> No, the sample uses a custom base64 encoding scheme: "WXYZlabcd3fghijko12e456789ABCDEFGHIJKL+/MNOPQRSTUVmn0pqrstuvwxyz".

8. How is communication terminated?

> Using the keyword 'exit'. The sample will then attemnpt to self-delete.

9. What is the purpose of this malware, and what role might it play in the
attacker’s arsenal?

> The purpose of this sample is to establish a reverse shell connection to the target over HTTP to masquerade as normal
> traffic on the network.

## Lab 14-3

This lab builds on Lab 14-1. Imagine that this malware is an attempt by
the attacker to improve his techniques. Analyze the malware found in file
Lab14-03.exe.

1. What hard-coded elements are used in the initial beacon? What ele-
ments, if any, would make a good signature?

> User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 3.0.4506.2152; .NET CLR 3.5.30729)
> http://www.practicalmalwareanalysis.com/start.htm
> UA-CPU: x86
>
> The user agent string is fairly common, and unlikely to be a long-lasting signature. However, as a result of the malware author's coding
> the string 'User-Agent' is actually duplicated, and will always be present. The URL and URI and the `UA-CPU: x86` header 
> are more specific, and would be more useful for signature creation.

2. What elements of the initial beacon may not be conducive to a long-
lasting signature?

> The user-agent string.

3. How does the malware obtain commands? What example from the
chapter used a similar methodology? What are the advantages of this
technique?

> The malware reads commands from the site's HTML, specifically the *noscript* tag. It examines the HTML for the start of the command string: 
> '<noscript' and then uses the next character to determine the option. It can be any word, so long as the first letter corresponds with a command option. 
> The option are 'd' - download, 'n' - do nothing, 'r' - redirect config, 's' - sleep, and 'q' - quit.

4. When the malware receives input, what checks are performed on the
input to determine whether it is a valid command? How does the
attacker hide the list of commands the malware is searching for?

> Commands must include `<noscript> http://<url that matches config>96'/command/arguments`. First letter of the command
> must correspond to one of the options available in the malware. 

5. What type of encoding is used for command arguments? How is it differ-
ent from Base64, and what advantages or disadvantages does it offer?

> The encoding is only used for the redirect and download commands, and it is a basic string and string indexing pattern.
> The string is '/abcdefghijklmnopqrstuvw0123456789'. This encoding alings with letters of the alphabet based on their index in the string.
> http:// = 08 20 20 16 37 00 00. At minimum it requires reversing from an analyst before it is understood, but it is not particularly challenging. 

6. What commands are available to this malware?

> quit, download, redirect, nothing, and sleep.

7. What is the purpose of this malware?

> Primarily a downloaded, with web-based control and ability to change the configuration on the fly.

8. This chapter introduced the idea of targeting different areas of code
with independent signatures (where possible) in order to add resiliency
to network indicators. What are some distinct areas of code or configura-
tion data that can be targeted by network signatures?

> Static domains and path; any dynamica information discovered
> Static components of the beacon
> Signatures related to the commands

9. What set of signatures should be used for this malware?

```snort
alert tcp $INT_NET any -> $EXT_NET $HTTP_PORTS
(
    msg:"14.3 - User-Agent Duplicate";
    content:"User-Agent|3a20|User-Agent|3a20|Mozilla/4.0|20|(compatible\;|20|MSIE|20|7.0\;|20|Windows|20|NT|20|5.1\;|20|.NET|20|CLR|20|3.0.4560.2152\;|20|.NET|20|CLR|20|3.5.30729)";
    http_header;
    sid: 00000004;
    rev:1;
)

alert tcp $INT_NET any -> $EXT_NET $HTTP_PORTS
(
    msg:"Lab14.3 - Noscript command";
    content:"<noscript>";
    content:"http\://";
    distance:0;
    within:512;
    content:"96'";
    distance:0;
    within:512;
    sid:00000005;
    rev:1;
)

alert tcp $INT_NET any -> $EXT_NET $HTTP_PORTS
(
    msg:"14.3 - Download or redirect";
    content:"/08202016370000";
    pcre:"/\/[dr][^\/]*\/08202016370000/";
    sid:00000006;
    rev:1;
)

alert tcp $INT_NET any -> $EXT_NET $HTTP_PORTS
(
    msg:"14.3 - Sleep";
    content:"96'";
    pcre:"/\/s[^\/]{0,15}\/[0-9]{2,20}96'/";
    sid:00000007;
    rev:1;
)
```

