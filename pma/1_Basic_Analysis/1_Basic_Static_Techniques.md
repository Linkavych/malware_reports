---

Author: @linkavych
Date: 2022-08-20

---
# Basic Static Techniques - Labs

## Lab 1-1

Filename: *Lab01-01.exe and Lab01-01.dll*

1. Upload the files to VirusTotal and view the reports. Does either file match any existing anti-virus signatures?

> EXE - sha256: 58898BD42C5BD3BF9B1389F0EEE5B39CD59180E8370EB9EA838A0B327BD6FE47
> VT Score: 54/71 - 2022-08-20
>
> DLL - sha256: F50E42C8DFAAB649BDE0398867E930B86C2A599E8DB83B8260393082268F2DBA
> VT Score: 44/70 - 2022-08-20

2. When were the files compiled?

> EXE - Sun Dec 19 16:16:19 2010 UTC
> DLL - Sun Dec 19 16:16:38 2010 UTC

3. Are there any indications that either of these files is packed or obfuscated? If so, what are the indicators?

> The entropy for both files is very low, suggesting the samples are not packed or otherwise obfuscated.
> Additionally, several strings are visible in both samples indicating what they may potentially be used for.

4. Do any imports hint at what this malware does? If so, which imports are they?

> EXE - The exe contains several imports from kernel32.dll which suggest process hollowing might be used to inject
> malware into a new process. `UnmapViewOfFile` and `MapViewOfFile` suggest this.
>
> Also, the EXE will create a new file on disc called kern132.dll, which is hiding in plain sight as the kernel32.dll system driver.
>
> DLL - The DLL imports socket functionality (ws2_32.dll) which suggests it will connect back to a C2 server of some form. The DLL will also spawn a Mutex,
> which is probably uses to check if the malware is already present on the ssytem before execution of the payload.
>
> The DLL's strings also contain a static IP address, which is probably the C2 server: 127.26.152.13. The strings 'exec', 'hwelo', and 'SADFHUHF' are
> also present. The last of which could be the mutex string.

5. Are there any files or host-based indicators that you could look for on infected systems?

> EXE - kernel132.dll - misnamed kernel32.dll
> DLL - MUTEX - 'SADHUHF'

6. What network-based indicators could be used to find this malware on infected machines?

> DLL - IP: 127.26.152.13

7. What would you guess is the purpose of these files?

> The EXE is likely a dropper which will map the payload DLL into memory and write it to disk
> as kerne132.dll. The DLL then serves as the backdoor to the target system, receiving commands
> via the 'exec' keyword. The backdoor will attempt to connect to 127.26.152.13, as a reverse shell, or it may bind to a local 
> port and wait for an additional connection.


## Lab 1-2

Filename: *Lab01-02.exe

1. Upload the Lab01-02.exe file to http://www.VirusTotal.com/. Does it match
any existing antivirus definitions?

> EXE - sha256: C876A332D7DD8DA331CB8EEE7AB7BF32752834D4B2B54EAA362674A2A48F64A6
> VT Score - 56/71

2. Are there any indications that this file is packed or obfuscated? If so,
what are these indicators? If the file is packed, unpack it if possible.

> The entropy for this sample is 5.25, which does not necessarily suggest it is packed. However,
> examining the file in pestudio shows the malware is packed with UPX. This is a simple, open-source packer, which
> can be easily unpacked by an analyst for additional analysis.
>
> The malware cna be unpacked by running: `upx -d <file> -o unpacked_sample.bin`

3. Do any imports hint at this program’s functionality? If so, which imports
are they and what do they tell you?

> The packed variant of the sample shows the imports `VirtualProtect`, `CreateServiceA`, `InternetOpenA`, and
> the remaining functions required for process injection - common for malware that needs to unpack itself to deliverr the
> payload.
>
> Unpacked, the malware shows additional functions which hint at its purpose:
>   - CreateServiceA, StartServiceCtrlDispatcherA, InternetOpenUrlA
>   - InternetOpenA
> The sample also shows functionality for creating a mutex, and further interactions
> with services via `OpenSCManagerA`. This suggests the malware creates persistence via a Windows
> service.
>
> The sample will interact with a webpage, which is shown in the strings of the malware as http://www.malwareanalysisbook.com.
> The malicious service will be called `MalService`.
>
> Unpacked, the malware also shows the MUTEX is likely 'HGL345', and the string 'Internet Explorer 8.0'

4. What host- or network-based indicators could be used to identify this
malware on infected machines?

> MALService - malicious service that will be installed
> http://www.malwareanalysisbook.com
> HGL345 - Mutex name


## Lab 1-3

Analyze the file Lab01-03.exe

1. Upload the Lab01-03.exe file to http://www.VirusTotal.com/. Does it match
any existing antivirus definitions?

> EXE - sha256: 7983A582939924C70E3DA2DA80FD3352EBC90DE7B8C4C427D484FF4F050F0AEC
> VT Score: 65/71

2. Are there any indications that this file is packed or obfuscated? If so,
what are these indicators? If the file is packed, unpack it if possible.

> Entropy for the file appears to be low with a score of: 2.379. Unlikely that this sample is packed.
> However, only one import can be found in kernel32.dll, suiggesting the binary is packed. The visible functions
> suggesst the sample will use basic process injection to inject its payload on the target system.
>
> This file is most likely packed, and based on the course at this point - cannot be unpacked.
> PEID identifies the packer as FSG

3. Do any imports hint at this program’s functionality? If so, which imports
are they and what do they tell you?

> N/A without unpacking.

4. What host- or network-based indicators could be used to identify this
malware on infected machines?

> N/A without unpacking.

## Lab 1-4

Analyze the file Lab01-04.exe.

1. Upload the Lab01-04.exe file to http://www.VirusTotal.com/. Does it match
any existing antivirus definitions?

> EXE - sha256: 0FA1498340FCA6C562CFA389AD3E93395F44C72FD128D7BA08579A69AAF3B126
> VT Score: 59/71 - 2022-08-20

2. Are there any indications that this file is packed or obfuscated? If so,
what are these indicators? If the file is packed, unpack it if possible.

> Entropy for the sample is very low at 1.177. Additionally, three DLLs are visible being imported,
> along with a high number of functions. It is likely this sample is not packed or obfuscated.

3. When was this program compiled?

> Fri Aug 30 22:26:59 2019 UTC - This would have been in the future at the time the book was published.
> As a result, we can assume the malware developer obscured the compiler timestamp deliberately.

4. Do any imports hint at this program’s functionality? If so, which imports
are they and what do they tell you?

> This sample contins a number of imported WinAPI functions that highlight its likely use. First, `WinExec` is imported which will execute a command on the system.
> Next, Token privilege functions are used (OpenProcessToken, AdjustTokenPrivileges, LookupPrivilegeValueA)
> likely meaning the malware will attempt to manipulate its privileges on the target system,
> or otherwise determine its level of privileges when executing. Finally, we have a number of imports dealing with resources
> for the sample itself (SizeofResource, FindResourceA, LoadResource). This means the malware is likely to load its
> payload from the .rsrc section of the binary and execute it on the target system.
>
> Also, urlmon.dll can be found in the strings of the binary. This could indicate the malware will attempt
> to interact with website on the internet. And with additional strings found, it is confirmed the malware will download a file from http[::]//www[.]practicalmalwareanalysis.com/updater.exe.
>
> Finally, the malware sample uses the WinAPI call: [GetTempPathA](https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-gettemppatha),
> which can show the analysts where the malware might have been downloaded.

5. What host- or network-based indicators could be used to identify this
malware on infected machines?

> - \system32\wupdmgr.exe
> - \winup.exe
> - http://www.practicalmalwareanalysis.com/updater.exe
> - winlogon.exe
> - updater.exe

6. This file has one resource in the resource section. Use Resource Hacker
to examine that resource, and then use it to extract the resource. What
can you learn from the resource?

> The resource is the final payload for the initial malware dropper. This malware has a sha256 hash of
> 819B2DB1876D85846811799664D512B2F1AF13E329F5DEBE60926C3B03424745. This dropped malware is not packed.
> The dropped sample imports kernel32.dll, urlmon.dll, and msvcrt.dll. Specifically, the sample
> calls WinExex, URLDownloadToFileA, GetTempPathA, and GetWindowsDirectoryA for use.
>
> It will call out to http[:]//www.practicalmalwareanalysis.com/updater.exe to download a file and save it
> as `winup.exe` on the target system in the TEMP path. It will then likely execute this file.
