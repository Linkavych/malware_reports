# Basic Dynamic Analysis

## Lab 3-1

Analyze the malware found in the file Lab03-01.exe using basic dynamic analy-
sis tools.

1. What are this malware’s imports and strings?

> This malware only imports kernel32.dll, and only the function `ExitProcess` can be seen. The binary only has two
> sections: the .text and .data sectin. The .data section has a moderately high entropy of 6.4.
>
> There are numerous strings which point to the samples functionality:
>   - www[.]practicalmalwareanalysis.com
>   - SOFTWARE\Classes\http\shell\open\commandV
>   - Software\Microsoft\Active Setup\Installed Components\
>   - SOFTWARE\Microsoft\Windows\CurrentVersion\Run
>   - SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders
>   - CONNECT %s:%i HTTP/1.0\r\n\r\n
>   - vmx32to64.exe
>   - VideoDriver
>   - WinVMX32
>   - admin
>   - test
>   - AppData
>
> Several strings point to additional DLLs being loaded by the sample:
>   - advapi32
>   - ntdll
>   - user32

2. What are the malware’s host-based indicators?

> See above, minus the webpage. Specifically, the malware writes the file `vmx32to64.exe` to c:\windows\system32\,
> and writes a new registry key `VideoDriver` in HKLM\SOFTWARE\MICROSOFT\Windows\CurrentVersion\Run.

3. Are there any useful network-based signatures for this malware? If so,
what are they?

> www[.]practicalmalwareanalysis.com
> CONNECT %s:%i HTTP/1.0\r\n\r\n
>
> The victim machine will resolve the above DNS query and then send a TCP packet of 256 bytes in length
> to the resolved server. The data appears to be random. This data is sent every minute, and appears to be beacon-like behavior.

## Lab 3-2
Analyze the malware found in the file Lab03-02.dll using basic dynamic analy-
sis tools.

1. How can you get this malware to install itself?

> This malware sample is a DLL. As such, using rundll32.exe should allow for the malware to be installed according to 
> its exported functions. The exported functions are: Install, ServiceMain, UninstallService, installA, and uninstallA.
>
> To install the malicious service, run: `rundll32.exe Lab03-02.dll, installA`. This will create a service
> named "Intranet Network Awareness (INA+)." The services name on the target will also be shown as `IPRIP`.

2. How would you get this malware to run after installation?

> To start the service on the target system: `sc start IPRIP`

3. How can you find the process under which this malware is running?

> The malware will execute under a svchost.exe process. Using process explorer, and searching for Lab03-02.dll, will show the specific process in questions.

4. Which filters could you set in order to use procmon to glean
information?

> Once the process is known, using the PID to filter in procmon will show the key events.

5. What are the malware’s host-based indicators?

> IPRIP - Service Name
> Intranet Network Awareness (INA+) - Service Display name
> Lab03-02.dll will be present on the victim system
> HKLM\System\CurrentControlSet\Services\IPRIP

6. Are there any useful network-based signatures for this malware?

> The malware will make a GET request to www[.]practicalmalwareanalysis.com/serve.html.
> The user agent for the request is: User-Agent: <computer name> Windows XP 6.11\r\n


## Lab 3-3
Execute the malware found in the file Lab03-03.exe while monitoring it using
basic dynamic analysis tools in a safe environment.

> During static analysis it is evident that the .rsrc section contains an additional payload which the first sample
> will load into memory and execute. This payload is XOR encoded with 0x41, noted by the repeating bytes of 0x41 throughout the encoded payload.
> XORing those bytes with 0x41 reveals the final payload, which can also be examined in detail.

1. What do you notice when monitoring this malware with Process
Explorer?

> The initial file is a dropper/loader for the final payload contained in the .rsrc section. This initial payload will load the payload into the memory of 
> a svchhost.exe process, and execute. The final payload is a keylogger, based on the strings decrypted
> when XORing the payload against 0x41. The keylogger will capture keystrokes into the log file:
> practicalmalwareanalysis.log.

2. Can you identify any live memory modifications?

> The sample is using process replacement to inject the payload into the target system. By following the
> newly created process with Process Explorer, and selecting the strings tab, a compairson between
> the strings on disk and in memory clearly shows the process has been replaced.

3. What are the malware’s host-based indicators?

> The malware will create the keylogger log file in the same directory where the initial
> binary was executed. The keylogger will continue to capture keystrokes as the
> victim interacts with the system.

4. What is the purpose of this program?

> The initial malware is a loader for the keylogger final payload.


## Lab 3-4

Analyze the malware found in the file Lab03-04.exe using basic dynamic analy-
sis tools. (This program is analyzed further in the Chapter 9 labs.)

1. What happens when you run this file?

> This malware sample requires command line arguments to be ran for execution. The options visible in string are:
> -cc, -re, -in. Additionally, the strings give a strong sense that this binary will install as a service, and communicate
> using http with a server at http://www[.]practicalmalwareanalysis.com. Further, it appears it can accept commands such as 'CMD', 'DOWNLOAD', 
> and 'UPLOAD'. When run with no command line parameters, the malware deletes itself from the target
> using cmd.exe /c del.
>
>

2. What is causing the roadblock in dynamic analysis?

> The malware requires the use of command line arguments to run.

3. Are there other ways to run this program?

> The sample requires additional analysis. Based on the current knowledge gained from the book, the sample uses
> more advanced functionality to execute on the target. To gain a better understanding more in-depth dynamic and static analysis 
> is required.
