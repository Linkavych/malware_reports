# Malware Traffic Analysis  - February 2023

Quiz: https://unit42.paloaltonetworks.com/feb-wireshark-quiz/
PCAP: https://github.com/pan-unit42/Wireshark-quizzes/blob/main/2023-02-Unit42-Wireshark-quiz.pcap.zip
Quiz Answers: https://unit42.paloaltonetworks.com/feb-wireshark-quiz-answers/

## Situation

Unknown. I pulled the above PCAP on 2023-02-20, but no assocated Quiz post from Unit42 or @malware_traffic has
been posted to this point. As a result, I'm just going to examine the PCAP as best I can - mainly
from the command line - and establish what I think is occuring.

## Network Overview

- Internal Network range: 10.0.0.0/24
- Gateway: 10.0.0.6 (WORK4US-DC) (Victim #2)
- Domain: WORK4US
- DC MAC: 00:C0:4F:7E:C8:4D

- Victim IP: 10.0.0.149
- Victim Username: damon.bauer
- Victim Computer host Name: DESKTOP-E7FHJS4
- Victim MAC: 00:21:5D:9E:42:FB

## Beginning

After running the PCAP through both Zeek and Suricata, I took a quick look at the `conn.log` to see how many conversations
are happening roughly: 1596, give or take. A quick look at the PCAP with `tcpdump` shows about 55207 packets in the file as well - so a fair bit of traffic
to sort through.

I assume this traffic contains some sort of malware activity, and based on the Zeek logs we can see what else might be involved.

![logs](images/logs.jpg)

Getting a quick sense of the ports at play in these conversations might provide a bit of a starting point:

```bash
cat conn.log | zeek-cut id.resp_p | sort | uniq -c | sort -nr

530 53
342 443
217 389
117 1900
78 135
75 49668
64 465
24 25
23 88
23 445
18 138
12 80
12 139
11 123
10 5353
8 137
2 67
2 49696
2 0
```

From this we can see a fair bit of DNS traffic, HTTPs, and a mixture of others including SMTP and SMB. All worth looking into.
The zeek `http.log` might give us a place to start for now, and then we can track backwards if needed.

```bash
cat http.logt | zeek-cut -dum ts id.orig_h id.resp_h id.resp_p method host uri user_agent response_body_len resp_mime_types

ts                        id.orig_h   id.resp_h        id.resp_p  method  host                  uri                                 user_agent                response_body_len  resp_mime_types
2023-02-03T17:04:23+0000  10.0.0.149  128.254.207.55   80         GET     128.254.207.55        /86607.dat                          curl/7.83.1               1761280            application/x-dosexec
2023-02-03T17:25:52+0000  10.0.0.149  192.229.211.108  80         GET     cacerts.digicert.com  /DigiCertTLSRSASHA2562020CA1-1.crt  Microsoft-CryptoAPI/10.0  1218               -
```

From this output, we can see our likely Victim (10.0.0.149) downloaded a file (86607.dat) via `GET` request from
IP `128.254.207[.]55` over port 80 HTTP. The zeek log identifies the file type as being `dosexec` and of size 1761280 bytes. Additionally,
this `GET` request was issued using `curl`, which is atypical. Grepping for this IP address in the DNS log returns nothing, so that's a 
connection worth examining in more detail.

Additionally, this `curl` command was issued at 1704UTC, relatively soon after the PCAP capture began at
1702UTC. Before I dive back to the suricata `fast.log`, I want to check the hash from this downloaded file to see what it might be.

```bash
cat files.log | zeek-cut tx_hosts rx_hosts mime_types sha1 | column -t

52.113.194.132   10.0.0.149  application/ocsp-response  4014352843f4f29ee3e495482706ca2bfd56fccd
13.89.179.10     10.0.0.149  application/ocsp-response  f379e3ad2b95421c3283a12829e8e2e3152429be
52.113.194.132   10.0.0.149  application/ocsp-response  756c5184b88e4d1fb6eed87b4ec117d59fb7acf0
128.254.207.55   10.0.0.149  application/x-dosexec      775aade0dcb211dbcdb896e42fa8ce95752b9081
... SNIP ...
122.3.47.118     10.0.0.149  application/ocsp-response  0ecb3b200a98b60b9595cf9254e9fa72baf82136
10.0.0.149       10.0.0.6    application/x-dosexec      775aade0dcb211dbcdb896e42fa8ce95752b9081
10.0.0.149       10.0.0.6    -                          126aab265cf4196c43f517730f5782977d7a0e36
```
Here we can see the SHA-1 hash of the file downloaded from `128.254.207[.]55`, and we also see that
it was transferred again from our Victim to the Domain Controller at `10.0.0.6`. Running the hash against VirusTotal we find that it is probably
Qakbot malware:

![vt-qakbot](images/qakbot.jpg)

## Suricata Timeline

Examining `fast.log` from Suricata, we can get a quick sense of the timeline again. As before,
Suricata shows the use of `curl` outbound to a dotted-quad IP address (times are -5hrs from UTC):

```text
02/03/2023-12:04:24.056313  [**] [1:2013028:7] ET POLICY curl User-Agent Outbound [**] [Classification: Attempted Information Leak] [Priority: 2] {TCP} 10.0.0.149:49750 -> 128.254.207.55:80
02/03/2023-12:04:24.056313  [**] [1:2034567:1] ET HUNTING curl User-Agent to Dotted Quad [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 10.0.0.149:49750 -> 128.254.207.55:80
```

These alerts correlate with what we have already found with zeek logs, and we can see additional
logs from Suricata based on our PCAP.

```text
02/03/2023-12:04:24.357185  [**] [1:2018959:4] ET POLICY PE EXE or DLL Windows file download HTTP [**] [Classification: Potential Corporate Privacy Violation] [Priority: 1] {TCP} 128.254.207.55:80 -> 10.0.0.149:49750
02/03/2023-12:04:24.357185  [**] [1:2021076:2] ET HUNTING SUSPICIOUS Dotted Quad Host MZ Response [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 128.254.207.55:80 -> 10.0.0.149:49750
02/03/2023-12:04:24.357185  [**] [1:2014520:8] ET INFO EXE - Served Attached HTTP [**] [Classification: Misc activity] [Priority: 3] {TCP} 128.254.207.55:80 -> 10.0.0.149:49750
02/03/2023-12:04:24.361112  [**] [1:2015744:6] ET INFO EXE IsDebuggerPresent (Used in Malware Anti-Debugging) [**] [Classification: Misc activity] [Priority: 3] {TCP} 128.254.207.55:80 -> 10.0.0.149:49750
```

From this, we can tell the downloaded file was likely executed on our Victim, and we can see the C2 traffic in our `fast.log` alerts.

```text
02/03/2023-12:12:20.319735  [**] [1:2028765:2] ET JA3 Hash - [Abuse.ch] Possible Dridex [**] [Classification: Unknown Traffic] [Priority: 3] {TCP} 10.0.0.149:49811 -> 102.156.32.143:443
02/03/2023-12:15:40.384099  [**] [1:2028765:2] ET JA3 Hash - [Abuse.ch] Possible Dridex [**] [Classification: Unknown Traffic] [Priority: 3] {TCP} 10.0.0.149:49835 -> 102.156.32.143:443
02/03/2023-12:17:32.883797  [**] [1:2404309:6734] ET CNC Feodo Tracker Reported CnC Server group 10 [**] [Classification: A Network Trojan was detected] [Priority: 1] {TCP} 10.0.0.149:49843 -> 208.187.122.74:443
02/03/2023-12:21:37.822658  [**] [1:2028765:2] ET JA3 Hash - [Abuse.ch] Possible Dridex [**] [Classification: Unknown Traffic] [Priority: 3] {TCP} 10.0.0.149:49875 -> 208.187.122.74:443
02/03/2023-12:24:48.361527  [**] [1:2028765:2] ET JA3 Hash - [Abuse.ch] Possible Dridex [**] [Classification: Unknown Traffic] [Priority: 3] {TCP} 10.0.0.149:49889 -> 208.187.122.74:443
02/03/2023-12:10:11.360144  [**] [1:2028765:2] ET JA3 Hash - [Abuse.ch] Possible Dridex [**] [Classification: Unknown Traffic] [Priority: 3] {TCP} 10.0.0.149:49796 -> 102.156.32.143:443
02/03/2023-12:14:01.245308  [**] [1:2028765:2] ET JA3 Hash - [Abuse.ch] Possible Dridex [**] [Classification: Unknown Traffic] [Priority: 3] {TCP} 10.0.0.149:49819 -> 102.156.32.143:443
02/03/2023-12:24:52.632750  [**] [1:2037841:1] ET MALWARE W32.DarkVNC Variant Checkin [**] [Classification: Malware Command and Control Activity Detected] [Priority: 1] {TCP} 10.0.0.149:49891 -> 78.31.67.7:443
...SNIP...
```
This gives us additional information to use in our investigation of this infection. It appears someone has downloaded Dridex/Qakbot malware onto
our Victim system, and it has executed successfully. We have several IP addresses that may be C2 or otherwise malicious:

- 128.254.207[.]55 - Initial Download
- 102.156.32[.]143 - Possible C2
- 208.187.122[.]74 - Possible C2
- 78.31.67[.]7 - DarkVNC Alert
- 5.75.205[.]43 - Possible Dridex based on JA3
- 122.3.47[.]118 - SMTP
- 216.163.188[.]54 - SMTP
- 122.155.171[.]181 - SMTP

We can also see, by going through all of the `fast.log` from Suricata that it appears
our victim host was used for lateral movement by the attackers to the Domain Controller
at 10.0.0.6 via SMB.

```bash
egrep -i smb fast.log

02/03/2023-14:47:49.852885  [**] [1:2025709:2] ET POLICY SMB2 NT Create AndX Request For a DLL File - Possible Lateral Movement [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 10.0.0.149:50765 -> 10.0.0.6:445
02/03/2023-14:47:50.101556  [**] [1:2025699:2] ET POLICY SMB Executable File Transfer [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 10.0.0.149:50764 -> 10.0.0.6:445
02/03/2023-14:47:50.101642  [**] [1:2025699:2] ET POLICY SMB Executable File Transfer [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 10.0.0.149:50764 -> 10.0.0.6:445
02/03/2023-14:47:50.101646  [**] [1:2025699:2] ET POLICY SMB Executable File Transfer [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 10.0.0.149:50764 -> 10.0.0.6:445
02/03/2023-14:48:25.116580  [**] [1:2025709:2] ET POLICY SMB2 NT Create AndX Request For a DLL File - Possible Lateral Movement [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 10.0.0.149:50766 -> 10.0.0.6:445
02/03/2023-14:48:25.129608  [**] [1:2025709:2] ET POLICY SMB2 NT Create AndX Request For a DLL File - Possible Lateral Movement [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 10.0.0.149:50766 -> 10.0.0.6:445
02/03/2023-14:48:30.179489  [**] [1:2025709:2] ET POLICY SMB2 NT Create AndX Request For a DLL File - Possible Lateral Movement [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 10.0.0.149:50766 -> 10.0.0.6:445
02/03/2023-14:49:00.191164  [**] [1:2025709:2] ET POLICY SMB2 NT Create AndX Request For a DLL File - Possible Lateral Movement [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 10.0.0.149:50764 -> 10.0.0.6:445
02/03/2023-14:49:10.683661  [**] [1:2025709:2] ET POLICY SMB2 NT Create AndX Request For a DLL File - Possible Lateral Movement [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 10.0.0.149:50765 -> 10.0.0.6:445
02/03/2023-14:47:14.815668  [**] [1:2025709:2] ET POLICY SMB2 NT Create AndX Request For a DLL File - Possible Lateral Movement [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 10.0.0.149:50760 -> 10.0.0.6:445
02/03/2023-14:47:14.817471  [**] [1:2025699:2] ET POLICY SMB Executable File Transfer [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 10.0.0.149:50760 -> 10.0.0.6:445
02/03/2023-14:47:14.817644  [**] [1:2025699:2] ET POLICY SMB Executable File Transfer [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 10.0.0.149:50760 -> 10.0.0.6:445
02/03/2023-14:47:14.817644  [**] [1:2025709:2] ET POLICY SMB2 NT Create AndX Request For a DLL File - Possible Lateral Movement [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 10.0.0.149:50760 -> 10.0.0.6:445
02/03/2023-14:47:14.817654  [**] [1:2025699:2] ET POLICY SMB Executable File Transfer [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 10.0.0.149:50760 -> 10.0.0.6:445
02/03/2023-14:47:14.817654  [**] [1:2025709:2] ET POLICY SMB2 NT Create AndX Request For a DLL File - Possible Lateral Movement [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 10.0.0.149:50760 -> 10.0.0.6:445
02/03/2023-14:47:19.836372  [**] [1:2025709:2] ET POLICY SMB2 NT Create AndX Request For a DLL File - Possible Lateral Movement [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 10.0.0.149:50760 -> 10.0.0.6:445
02/03/2023-14:47:50.100777  [**] [1:2025709:2] ET POLICY SMB2 NT Create AndX Request For a DLL File - Possible Lateral Movement [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 10.0.0.149:50760 -> 10.0.0.6:445
02/03/2023-14:47:55.114314  [**] [1:2025709:2] ET POLICY SMB2 NT Create AndX Request For a DLL File - Possible Lateral Movement [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 10.0.0.149:50760 -> 10.0.0.6:445
02/03/2023-14:48:25.131255  [**] [1:2025699:2] ET POLICY SMB Executable File Transfer [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 10.0.0.149:50760 -> 10.0.0.6:445
02/03/2023-14:48:25.131396  [**] [1:2025699:2] ET POLICY SMB Executable File Transfer [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 10.0.0.149:50760 -> 10.0.0.6:445
02/03/2023-14:48:25.131396  [**] [1:2025709:2] ET POLICY SMB2 NT Create AndX Request For a DLL File - Possible Lateral Movement [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 10.0.0.149:50760 -> 10.0.0.6:445
02/03/2023-14:48:25.131400  [**] [1:2025699:2] ET POLICY SMB Executable File Transfer [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 10.0.0.149:50760 -> 10.0.0.6:445
02/03/2023-14:48:25.131400  [**] [1:2025709:2] ET POLICY SMB2 NT Create AndX Request For a DLL File - Possible Lateral Movement [**] [Classification: Potentially Bad Traffic] [Priority: 2] {TCP} 10.0.0.149:50760 -> 10.0.0.6:445
```

## Next Steps

So we probably have two victims (10.0.0.149 and .6). The attackers have probably compromised the Domain Controller in this case,
so it's probably safe to assume the domain is compromised at this point. We also know lateral movement was done via SMB, and so we can recover
those files as well - which Zeek has also identified.

Basic timeline is as follows:

2023-02-03:
- 1704UTC - Download of Dridex/Qakbot malware via `curl` to .149 Victim Desktop.
- 1710UTC - C2 Communications to various IPs begins
- 1928UTC - TLS SMTP Traffic Established with 158.69.38[.]117 (mail.pjmachinage[.]com) and 64.29.145[.]194 (mail.consolidated[.]com)
- 1947UTC - SMB Lateral Movement to Domain Controller 10.0.0.6

Before examining the SMB lateral movement, lets take a look at the potential C2 servers discovered already.

```bash
cat conn.log | zeek-cut -du ts id.orig_h id.resp_h id.resp_p resp_bytes | egrep '102\.156'

2023-02-03T17:10:03+0000        10.0.0.149      102.156.32.143  443     1673
2023-02-03T17:10:09+0000        10.0.0.149      102.156.32.143  443     109
2023-02-03T17:12:19+0000        10.0.0.149      102.156.32.143  443     109
2023-02-03T17:14:00+0000        10.0.0.149      102.156.32.143  443     109
2023-02-03T17:15:39+0000        10.0.0.149      102.156.32.143  443     109

cat conn.log | zeek-cut -du ts id.orig_h id.resp_h id.resp_p resp_bytes | egrep '208\.187'

2023-02-03T17:17:32+0000        10.0.0.149      208.187.122.74  443     1633
2023-02-03T17:17:55+0000        10.0.0.149      208.187.122.74  443     1203
2023-02-03T17:18:27+0000        10.0.0.149      208.187.122.74  443     1227
2023-02-03T17:17:55+0000        10.0.0.149      208.187.122.74  443     271
2023-02-03T17:21:36+0000        10.0.0.149      208.187.122.74  443     891
2023-02-03T17:24:48+0000        10.0.0.149      208.187.122.74  443     468394
2023-02-03T17:25:52+0000        10.0.0.149      208.187.122.74  443     1328
2023-02-03T17:24:50+0000        10.0.0.149      208.187.122.74  443     271
2023-02-03T17:29:01+0000        10.0.0.149      208.187.122.74  443     967
2023-02-03T17:32:13+0000        10.0.0.149      208.187.122.74  443     1191
2023-02-03T17:35:22+0000        10.0.0.149      208.187.122.74  443     963
2023-02-03T17:38:34+0000        10.0.0.149      208.187.122.74  443     927
2023-02-03T17:41:42+0000        10.0.0.149      208.187.122.74  443     863
2023-02-03T17:44:55+0000        10.0.0.149      208.187.122.74  443     895
2023-02-03T17:48:07+0000        10.0.0.149      208.187.122.74  443     1240
2023-02-03T17:51:15+0000        10.0.0.149      208.187.122.74  443     1127
2023-02-03T17:54:28+0000        10.0.0.149      208.187.122.74  443     899
2023-02-03T17:57:36+0000        10.0.0.149      208.187.122.74  443     1344
2023-02-03T18:00:49+0000        10.0.0.149      208.187.122.74  443     823
2023-02-03T18:04:01+0000        10.0.0.149      208.187.122.74  443     1276
2023-02-03T18:07:10+0000        10.0.0.149      208.187.122.74  443     1195
2023-02-03T18:10:22+0000        10.0.0.149      208.187.122.74  443     907
2023-02-03T18:13:31+0000        10.0.0.149      208.187.122.74  443     1428
2023-02-03T17:17:33+0000        10.0.0.149      208.187.122.74  443     109
2023-02-03T18:16:43+0000        10.0.0.149      208.187.122.74  443     1424
2023-02-03T18:19:55+0000        10.0.0.149      208.187.122.74  443     895
2023-02-03T18:23:04+0000        10.0.0.149      208.187.122.74  443     0
2023-02-03T18:23:34+0000        10.0.0.149      208.187.122.74  443     0
2023-02-03T18:24:04+0000        10.0.0.149      208.187.122.74  443     2410
2023-02-03T18:26:16+0000        10.0.0.149      208.187.122.74  443     1187
2023-02-03T18:29:25+0000        10.0.0.149      208.187.122.74  443     903
2023-02-03T18:32:38+0000        10.0.0.149      208.187.122.74  443     811
2023-02-03T18:35:45+0000        10.0.0.149      208.187.122.74  443     1039
2023-02-03T18:38:59+0000        10.0.0.149      208.187.122.74  443     875
2023-02-03T18:42:06+0000        10.0.0.149      208.187.122.74  443     1336
2023-02-03T18:45:20+0000        10.0.0.149      208.187.122.74  443     1312
2023-02-03T18:48:31+0000        10.0.0.149      208.187.122.74  443     0
2023-02-03T18:49:01+0000        10.0.0.149      208.187.122.74  443     0
2023-02-03T18:49:31+0000        10.0.0.149      208.187.122.74  443     2655
2023-02-03T18:51:39+0000        10.0.0.149      208.187.122.74  443     999
2023-02-03T18:54:53+0000        10.0.0.149      208.187.122.74  443     999
2023-02-03T18:58:01+0000        10.0.0.149      208.187.122.74  443     1256
2023-02-03T19:01:13+0000        10.0.0.149      208.187.122.74  443     1292
2023-02-03T19:04:21+0000        10.0.0.149      208.187.122.74  443     1003
2023-02-03T19:07:34+0000        10.0.0.149      208.187.122.74  443     1268
2023-02-03T19:10:48+0000        10.0.0.149      208.187.122.74  443     1051
2023-02-03T19:13:54+0000        10.0.0.149      208.187.122.74  443     1035
2023-02-03T19:17:08+0000        10.0.0.149      208.187.122.74  443     1280
2023-02-03T19:20:16+0000        10.0.0.149      208.187.122.74  443     845641
2023-02-03T19:20:23+0000        10.0.0.149      208.187.122.74  443     271
2023-02-03T19:21:20+0000        10.0.0.149      208.187.122.74  443     271
2023-02-03T19:21:19+0000        10.0.0.149      208.187.122.74  443     1336
2023-02-03T19:22:24+0000        10.0.0.149      208.187.122.74  443     196581
2023-02-03T19:22:28+0000        10.0.0.149      208.187.122.74  443     271
2023-02-03T19:23:28+0000        10.0.0.149      208.187.122.74  443     1863472
2023-02-03T19:23:31+0000        10.0.0.149      208.187.122.74  443     271
2023-02-03T19:24:34+0000        10.0.0.149      208.187.122.74  443     271
2023-02-03T19:24:32+0000        10.0.0.149      208.187.122.74  443     730298
2023-02-03T19:24:52+0000        10.0.0.149      208.187.122.74  443     140
2023-02-03T19:24:52+0000        10.0.0.149      208.187.122.74  443     391
2023-02-03T19:25:22+0000        10.0.0.149      208.187.122.74  443     419
2023-02-03T19:25:32+0000        10.0.0.149      208.187.122.74  443     825276
2023-02-03T19:25:42+0000        10.0.0.149      208.187.122.74  443     271
2023-02-03T19:26:41+0000        10.0.0.149      208.187.122.74  443     271
2023-02-03T19:26:37+0000        10.0.0.149      208.187.122.74  443     1432
2023-02-03T19:27:42+0000        10.0.0.149      208.187.122.74  443     1085161
2023-02-03T19:27:49+0000        10.0.0.149      208.187.122.74  443     271
2023-02-03T19:28:01+0000        10.0.0.149      208.187.122.74  443     347
2023-02-03T19:28:01+0000        10.0.0.149      208.187.122.74  443     419
2023-02-03T19:28:45+0000        10.0.0.149      208.187.122.74  443     1195
2023-02-03T19:31:57+0000        10.0.0.149      208.187.122.74  443     1272
2023-02-03T19:35:05+0000        10.0.0.149      208.187.122.74  443     1155
2023-02-03T19:38:19+0000        10.0.0.149      208.187.122.74  443     1340
2023-02-03T19:41:26+0000        10.0.0.149      208.187.122.74  443     1083
2023-02-03T19:44:39+0000        10.0.0.149      208.187.122.74  443     1444
2023-02-03T19:47:51+0000        10.0.0.149      208.187.122.74  443     1456
2023-02-03T19:50:59+0000        10.0.0.149      208.187.122.74  443     1340
2023-02-03T19:54:12+0000        10.0.0.149      208.187.122.74  443     1340

cat conn.log | zeek-cut -du ts id.orig_h id.resp_h id.resp_p resp_bytes | egrep '78\.31'

2023-02-03T19:23:16+0000        10.0.0.149      78.31.67.7      443     20265
2023-02-03T17:24:52+0000        10.0.0.149      78.31.67.7      443     1950

cat conn.log | zeek-cut -du ts id.orig_h id.resp_h id.resp_p resp_bytes | egrep '5\.75'

2023-02-03T19:21:24+0000        10.0.0.149      5.75.205.43     443     1638
2023-02-03T19:21:30+0000        10.0.0.149      5.75.205.43     443     278
2023-02-03T19:21:38+0000        10.0.0.149      5.75.205.43     443     278
2023-02-03T19:21:43+0000        10.0.0.149      5.75.205.43     443     278
```

Based on the above, we can see several short connections that were not sustained for C2, but were successful. However, 
the connection with `208.187.122[.]74` persisted from execution of the downloaded malware to the 
end of the PCAP file. Based on the response bytes (the final column), we can see where it varies and
the connections appear to be about three minutes apart. This appears to be beaconing behavior and executing commands at
certain times. If you have RITA, you can load your zeek logs from this PCAP into a database and the beaconing behavior of this
IP address will be confirmed.

![rita beacons](images/rita.jpg)

So the primary C2 server is `208.187.122[.]74`, which was not resolved through a DNS query. The communication has been encrypted
with an invalid TLS cert, as shown below from the `notice.log` generated by Zeek's BZAR package.

```text
2023-02-03T17:10:05+0000        10.0.0.149      102.156.32.143  SSL::Invalid_Server_Cert        CN=ujcbhafnfs.mobi,OU=Jehfbkbwha,C=NL
2023-02-03T17:17:33+0000        10.0.0.149      208.187.122.74  SSL::Invalid_Server_Cert        CN=ptvcdl.mobi,OU=Qwpai Eugeaj Ncoeuvdg,C=PT
2023-02-03T18:24:04+0000        10.0.0.149      208.187.122.74  SSL::Invalid_Server_Cert        CN=ptvcdl.mobi,OU=Qwpai Eugeaj Ncoeuvdg,C=PT
2023-02-03T19:21:25+0000        10.0.0.149      5.75.205.43     SSL::Invalid_Server_Cert        CN=vipsauna.com,O=vipsauna.com,L=Los Angeles,ST=CA,C=US
```

## SMB Files

Extracting the files using Wireshark from the SMB stream is easy enough. All three of the DLLs captured
in the PCAP share the same hash as our earlier malware: 775aade0dcb211dbcdb896e42fa8ce95752b9081 (SHA-1).
This goes back to Qakbot, and CAPE Sandbox has a good rundown for [this sample](https://www.capesandbox.com/analysis/361187/).

Again, we can assume the attacker now has access to the Domain Controller, and would need to take action to remediate.

## DNS Resolved

Going back to the DNS traffic captured by zeek in the `dns.log` we can grep out the more relevant traffic,
excluding domains belonging to microsoft, oracle, and a few others.

```bash
cat dns.log | zeek-cut query answers | egrep -iv 'microsoft|oracle|wpad|ldap|google|msft|\-' | sort | uniq -c | sort -nr | column -t

3  www.broadcom.com                    cdn.broadcom.com,www.broadcom.com.cdn.cloudflare.net,172.64.155.106,104.18.32.150
3  verisign.com                        209.131.162.45,69.58.187.40
3  linkedin.com                        13.107.42.14
2  www.verisign.com                    69.58.187.40
2  www.verisign.com                    209.131.162.45
2  www.cisco.com                       www.cisco.com.akadns.net,wwwds.cisco.com.edgekey.net,wwwds.cisco.com.edgekey.net.globalredir.akadns.net,e2867.dsca.akamaiedge.net,23.64.146.226
2  irs.gov                             152.216.7.110,152.216.11.110
2  cisco.com                           72.163.4.185
1  zimbra.misshosting.com              185.76.64.230
1  yahoo.com                           98.137.11.164,74.6.231.20,74.6.143.25,74.6.143.26,74.6.231.21,98.137.11.163
1  yahoo.com                           74.6.143.26,98.137.11.164,74.6.231.21,98.137.11.163,74.6.143.25,74.6.231.20
1  xfinity.com                         96.114.21.40,96.114.14.140,68.87.41.40
1  www.xfinity.com                     www.xfinity.com.edgekey.net,e10994.dscx.akamaiedge.net,184.86.169.24
1  www.irs.gov                         www.irs.gov.edgekey.net,e3920.dscna.akamaiedge.net,23.214.54.85
1  www.irs.gov                         www.irs.gov.edgekey.net,e3920.dscna.akamaiedge.net,23.210.67.195
1  www.cisco.com                       www.cisco.com.akadns.net,wwwds.cisco.com.edgekey.net,wwwds.cisco.com.edgekey.net.globalredir.akadns.net,e2867.dsca.akamaiedge.net,96.6.184.69
1  www.cisco.com                       www.cisco.com.akadns.net,wwwds.cisco.com.edgekey.net,wwwds.cisco.com.edgekey.net.globalredir.akadns.net,e2867.dsca.akamaiedge.net,184.51.39.62
1  verisign.com                        69.58.187.40,209.131.162.45
1  toshak.com                          88.135.68.140
1  smtp.searchlinkasia.com             122.3.47.118
1  smtp.nixeft.com                     45.32.205.246
1  smtp.mail.com                       74.208.5.15
1  smtp.macnels.co.th                  122.155.171.181
1  smtp.gmail.com                      142.250.115.108
1  smtp.aol.com                        smtp.cs.com,smtp.aol.g03.yahoodns.net,66.163.170.44,66.218.88.159
1  nexusrules.officeapps.live.com      prod.nexusrules.live.com.akadns.net,52.109.8.44
1  nexusrules.officeapps.live.com      prod.nexusrules.live.com.akadns.net,52.109.77.2
1  mx.rediffmail.rediff.akadns.net     202.137.234.30
1  mx.dca.untd.com                     64.136.44.37
1  mx2.telmexco.mail2world.com         mx2.pangia.biz,216.163.188.54,216.163.176.38
1  mx1.omantel.net.om                  212.72.4.80
1  mail.tugasakhirkomp.com             23.163.0.79
1  mail.transcellapps.in               148.66.137.26
1  mail.techmaxz.xyz                   127.0.0.1
1  mail.stockmadino.ir                 stockmadino.ir,163.172.203.87
1  mail.silvanadiasimobiliaria.com.br  192.185.212.139
1  mail.seyyana.com                    34.98.99.30
1  mail.ruralcinemas.com               148.72.246.50
1  mail.quizadda.ml                    quizadda.ml,194.195.119.245
1  mail.pjmachinage.com                158.69.38.117
1  mail.pcrecreation.org               107.180.26.64
1  mail.newbiochemist.com              91.195.240.12
1  mail.mulherfacil.com                127.0.0.1
1  mail.mpstuccoplaster.com            34.98.99.30
1  mail.mazorquetextil.com.br          192.185.213.59
1  mail.libertybooks.com               104.21.7.246,172.67.188.29
1  mail.jasapembasmirayap.com          199.59.242.150
1  mail.hpfp3542.odns.fr               hpfp3542.odns.fr,109.234.164.201
1  mail.hexadigital.ae                 43.255.154.34
1  mail.glassplaque.co.za              169.239.217.31
1  mail.garagechivilcoy.com.ar         garagechivilcoy.com.ar,170.78.75.97
1  mail.econservices.in                184.168.96.183
1  mail.consolidated.net               64.29.145.194
1  mail.cesuver.com                    91.195.240.117
1  mail.capitalrealities.com           capitalrealities.com,216.239.38.21,216.239.34.21,216.239.32.21,216.239.36.21
1  mail.camel4x4tours.com              99.83.154.118
1  mail.borna62.net                    borna62.net,198.38.82.29
1  mail.blupoxy.biz                    91.195.240.12
1  mail.barokah.website                91.195.240.117
1  mail.a2zjobzone.com                 a2zjobzone.com,103.92.235.87
1  mail2.econt.com                     95.43.201.111
1  ferlintiozzo.com                    185.2.4.16
1  client.wns.windows.com              wns.notify.trafficmanager.net,20.10.31.115
1  cacerts.digicert.com                fp2e7a.wpc.2be4.phicdn.net,fp2e7a.wpc.phicdn.net,192.229.211.108
1  broadcom.com                        52.13.171.212,54.68.22.26,50.112.202.115
1  broadcom.com                        52.13.171.212,50.112.202.115,54.68.22.26
```

This shows how many domains, particularly mail domains, were in the traffic for potential exfiltration of data.
This list also, purposely, excludes those domains which did not resolve to an IP address. While some of this traffic may be legit,
given the context of the PCAP it would be worth additional monitoring across these domains.

## Conclusion

I recognize that I, mostly, bounced a bit back and forth while examining this PCAP. Unlike before, I am/was sort of operating in the blind
as to the desired outcomes, but I think it has become fairly clear.

On 2023-02-03 at approximately 1704 UTC a Desktop (DESKTOP-E7FHJS4) operated by user Damon Bauer (damon.bauer) at local IP 10.0.0.149 downloaded
Qakbot/Dridex malware from 128.254.207[.]55 using the `curl` utility from the desktop. Immediately following, C2 communication made successfull connections to 
multiple C2 servers, transferred data, and established beaconing behavior to one IP.

At approximatelky 1928 UTC the system began reaching out to multiple SMTP servers to establish connections, successfully negotiating TLS sessions. The malware also 
reached out to SMTP server `122.155.171[.]181` with clear-text credentials: User - `arthit@macnels.co.th`, Password - `Art123456`.

At 1947 UTC SMB and SMB2 traffic indicated the attacker was conducting lateral movement to the domain controller at 10.0.0.6, transferring the same malware that was downloaded by the earlier host.

The PCAP ends at 2023-02-03 1954 UTC still maintaining C2 beacon behavior with a known malicious IP address.

One, unconfirmed hypothesis I had while examining this PCAP was that our original Victim (10.0.0.149) was in fact being operated by the attacker.
Normal users are unlikely to use command line tools such as `curl`, but an attacker might be mroe comfortable on the command line.
If that was the case, then the original infection in the network began before the start of this pcap.
