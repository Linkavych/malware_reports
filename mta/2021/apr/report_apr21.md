---

author: @linkavych
date: 2022-10-01
link: 

---
# Incident Report - April 2021 - Forensic Quiz

## Executive Summary

At UTC 22:23 on March 29, 2021, the user Wilmer Coughlin executed a malicious Excel document which subsequently downloaded BazaarLoader, Cobatl Strike, and AnchorDNS malware.

## Detailed Analysis

At some point prior to the start of the packet capture (22:23 UTC on March 29, 2021), the user Wilmer Coughlin
downloaded, ran, and enabled macros in an XLS spreadhsheet named: `subscription_1617056233.xlsb` with a sha256 hash of
`ae6dbc08e0e21b217352175f916cfd5269c4fd8d5de6bff2d0a93a366f78e8d1`. This XLS document contained Excel4 Macros that saved data to
the target system in the files `4123.xsg` and `4123.xlsb`. `4123.xsg` contains base64 encoded data
which is decoded via enother macro using the *certutil* utility. This is saved as a DLL file consistent with [BazarLoader](https://malpedia.caad.fkie.fraunhofer.de/details/win.bazarbackdoor).

<img src="images/macros.jpg" width=1000 align=center>

At UTC 22:18 the DLL calls out to `veso2[.]xyz` at IP `176.111.174[.]53`. This initial POST request to the URI `/campo/r/r1` is redirected
to `admin.youngleeindia[.]in` at IP `104.21.74[.]174`. Another POST request is issued to the URI `/uploads/files/rt3ret3.exe` resulting in a malicious 
binary being downloaded. The malware is saved to `c:\ProgramData\huqvg\huqvg.exe` with a sha256 hash of `291c573996c647508544e8e21bd2764e6e4c834d53d6d2c8903a0001c783764b`.

<img src="images/bazarloader.jpg" width=1000 align=center>

After this malware is downloaded, the system begins to communicate with two IP addresses sharing the same TLS certificate: `54.184.119[.]29` and `184.72.1[.]208`. This communication
takes place within DNS resolution, and a sginificant amount of data is transferred to and from the system.

<img src="images/tls.jpg" width=1000 align=center>

At 22:58 UTC a GET request is issued to `217.12.218[.]46` to URI `/YPbR`. This is a common CobaltStrike style
of URI for downloading a payload. The GET request returns encoded data, thjat is likely a Cobalt Strike payload. Based on the artifacts found on the
system, this is likely true. A DLL was found at `c:\users\wilmer.coughlin\AppData\Local\Temp\C618.tmp.dll` with a sha256 hash of
`cc74f7e82eb33a14ffdea343a8975d8a81be151ffcb753cb3f3be10242c8a252`. This returns as a Cobalt Strike beacon
from [Malware Bazaar](https://bazaar.abuse.ch/sample/cc74f7e82eb33a14ffdea343a8975d8a81be151ffcb753cb3f3be10242c8a252/).

Further, beginning immediately after this download, the system begins communicating regularly with the same server as a C2 node
for CobaltStrike. This is confirmed by the CobaltStrike C2 configuration as well. The domain `onedrive.live.com` is associated with the IP address after the C2 communication begins.

<img src="images/csc2.jpg" width=1000 align=center>

At 23:10 UTC a public IP check is made by querying `checkip.amazonaws.com`, followed by a query for the domain `xyskencevli[.]com`.

<img src="images/pub.jpg" width=1000 align=center>

At 23:14 another DNS query is made for the domain `sluaknhbsoe[.]com` and this resolves to the IP `195.123.210[.]110`. As a result,
the system begins to communicate using DNS queries to this domain. The pattern of query is indicative of [AnchorDNS malware](https://malpedia.caad.fkie.fraunhofer.de/details/elf.anchor_dns).

<img src="images/anchor.jpg" width=1000 align=center>

Based on this brief analysis, BazarLoader, CobaltStrike, and AnchorDNS malware are all present on the system The last is confirmed by the artifacts found on the target
system at `c:\Windows\Temp\adf\`. Three files were at this location:

1. anchorAsjuster_x64.exe - sha256: 3ab8a1ee10bd1b720e1c8a8795e78cdc09fec73a6bb91526c0ccd2dc2cfbc28d
2. anchor_x64.exe - sha256: a8a8c66b155fcf9bfdf34ba0aca98991440c3d34b8a597c3fdebc8da251c9634
3. anchorDNS_x64.exe - sha256: 9fdbd76141ec43b6867f091a2dca503edb2a85e4b98a4500611f5fe484109513

And the schedule task found at `c:\windows\System32\Tasks\Sun SvcRestartTask#32640`, which is shown below:

```xml
<?xml version="1.0" encoding="UTF-16"?>
<Task version="1.2" xmlns="http://schemas.microsoft.com/windows/2004/02/mit/task">
  <RegistrationInfo>
    <URI>\Sun SvcRestartTask#32640</URI>
  </RegistrationInfo>
  <Triggers>
    <CalendarTrigger>
      <Repetition>
        <Interval>PT2M</Interval>
        <Duration>PT24H</Duration>
        <StopAtDurationEnd>false</StopAtDurationEnd>
      </Repetition>
      <StartBoundary>2021-03-29T23:10:50</StartBoundary>
      <EndBoundary>2031-12-31T23:59:59</EndBoundary>
      <Enabled>true</Enabled>
      <ScheduleByDay>
        <DaysInterval>1</DaysInterval>
      </ScheduleByDay>
    </CalendarTrigger>
    <LogonTrigger id="TriggerLogon">
      <StartBoundary>2021-03-29T23:10:50</StartBoundary>
      <EndBoundary>2031-12-31T23:59:59</EndBoundary>
      <Enabled>true</Enabled>
      <UserId>wilmer.coughlin</UserId>
    </LogonTrigger>
  </Triggers>
  <Settings>
    <MultipleInstancesPolicy>IgnoreNew</MultipleInstancesPolicy>
    <DisallowStartIfOnBatteries>false</DisallowStartIfOnBatteries>
    <StopIfGoingOnBatteries>false</StopIfGoingOnBatteries>
    <AllowHardTerminate>true</AllowHardTerminate>
    <StartWhenAvailable>true</StartWhenAvailable>
    <RunOnlyIfNetworkAvailable>false</RunOnlyIfNetworkAvailable>
    <IdleSettings>
      <Duration>PT10M</Duration>
      <WaitTimeout>PT1H</WaitTimeout>
      <StopOnIdleEnd>true</StopOnIdleEnd>
      <RestartOnIdle>false</RestartOnIdle>
    </IdleSettings>
    <AllowStartOnDemand>true</AllowStartOnDemand>
    <Enabled>true</Enabled>
    <Hidden>false</Hidden>
    <RunOnlyIfIdle>false</RunOnlyIfIdle>
    <WakeToRun>false</WakeToRun>
    <ExecutionTimeLimit>PT72H</ExecutionTimeLimit>
    <Priority>7</Priority>
  </Settings>
  <Actions Context="Author">
    <Exec>
      <Command>C:\Windows\Temp\adf\anchor_x64.exe</Command>
      <Arguments>-u</Arguments>
    </Exec>
  </Actions>
  <Principals>
    <Principal id="Author">
      <UserId>wilmer.coughlin</UserId>
      <LogonType>InteractiveToken</LogonType>
      <RunLevel>LeastPrivilege</RunLevel>
    </Principal>
  </Principals>
</Task>
```

### Local System

- IP: 192.168.5.125
- Hostname: laptop-x9naq2eu
- MAC: 14:b3:1f:9d:33:92
- User: Wilmer Coughlin
- Username: wilmer.coughlin

## Indicators of Compromise

SHA256 hash: ae6dbc08e0e21b217352175f916cfd5269c4fd8d5de6bff2d0a93a366f78e8d1
File size: 181,413 bytes
File name: subscription_1617056233.xlsb
File description: Spreadsheet with macros for BazaLoader (BazarLoader)

SHA256 hash: 291c573996c647508544e8e21bd2764e6e4c834d53d6d2c8903a0001c783764b
File size: 242,176 bytes
File location: hxxp://veso2[.]xyz/uploads/files/rt3ret3.exe
File location: C:\ProgramData\huqvg\huqvg.exe
File description: EXE for BazaLoader (BazarLoader)

SHA256 hash: cc74f7e82eb33a14ffdea343a8975d8a81be151ffcb753cb3f3be10242c8a252
File size: 299,520 bytes
File location: C:\Users\wilmer.coughlin\AppData\Local\Temp\C618.tmp.dll
File description: DLL for Cobalt Strike
Run method: rundll32.exe [filename],lowslow

SHA256 hash: 3ab8a1ee10bd1b720e1c8a8795e78cdc09fec73a6bb91526c0ccd2dc2cfbc28d
File size: 251,904 bytes
File location: C:\Windows\Temp\adf\anchorAsjuster_x64.exe
File description: Anchor malware EXE (1 of 3)
Note: This is not inherently malicious on its own, but can be used to run the other two Anchor files.

SHA256 hash: a8a8c66b155fcf9bfdf34ba0aca98991440c3d34b8a597c3fdebc8da251c9634
File size: 347,648 bytes
File location: C:\Windows\Temp\adf\anchor_x64.exe
File description: Anchor malware EXE (2 of 3)

SHA256 hash: 9fdbd76141ec43b6867f091a2dca503edb2a85e4b98a4500611f5fe484109513
File size: 347,648 bytes
File location: C:\Windows\Temp\adf\anchorDNS_x64.exe
File description: Anchor malware EXE (3 of 3)

### HTTPS traffic that returned malicious spreadsheet:

8.209.100[.]246 port 443 - gtmers[.]xyz

### BazaLoader traffic:

176.111.174[.]53 port 80 - veso2[.]xyz - POST /campo/r/r1
104.21.74[.]174 port 80 - admin.yougleeindia[.]in - POST /theme/js/plugins/rt3ret3.exe
176.111.174[.]53 port 80 - veso2[.]xyz - POST /uploads/files/rt3ret3.exe
54.184.119[.]29 port 443 - HTTPS traffic caused by BazaLoader (BazarLoader)
184.72.1[.]208 port 443 - HTTPS traffic caused by BazaLoader (BazarLoader)

### IP address checks by the infected Windows host:

port 80 - api.ip[.]sb - GET /ip
port 80 - checkip.amazonaws[.]com - GET /

### Cobalt Strike traffic:

217.12.218[.]46 port 80 - 217.12.218[.]46 - GET /YPbR
217.12.218[.]46 port 80 - onedrive.live[.]com - GET /preload?manifest=wac
217.12.218[.]46 port 80 - onedrive.live[.]com - GET /sa

### Domains used by Anchor malware:

sluaknhbsoe[.]com
xyskencevli[.]com

